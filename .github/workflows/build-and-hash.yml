name: Build and Hash Tailscale-UDM

on:
  workflow_dispatch:
    inputs:
      tailscale_version:
        description: 'Tailscale version to build (e.g., 1.76.1)'
        required: true
        type: string
      build_number:
        description: 'Build number (default: 1)'
        required: false
        default: '1'
        type: string
  schedule:
    # Run weekly on Sundays at 2 AM UTC to catch new releases
    - cron: '0 2 * * 0'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Determine Tailscale version
        id: version
        run: |
          if [ -n "${{ inputs.tailscale_version }}" ]; then
            VERSION="${{ inputs.tailscale_version }}"
            BUILD_NUMBER="${{ inputs.build_number }}"
          else
            # Fetch latest Tailscale version from their releases
            echo "Fetching latest Tailscale version..."
            VERSION=$(curl -sSL https://api.github.com/repos/tailscale/tailscale/releases/latest | sed -n 's/.*"tag_name": *"v\([^"]*\)".*/\1/p' | head -1)
            BUILD_NUMBER="1"
          fi

          # Validate version format (X.Y.Z)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Invalid version format: $VERSION (expected: X.Y.Z)"
            exit 1
          fi

          # Validate build number is numeric
          if ! echo "$BUILD_NUMBER" | grep -qE '^[0-9]+$'; then
            echo "ERROR: Invalid build number: $BUILD_NUMBER (expected: numeric)"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}-${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "Building Tailscale version: $VERSION (Build: $BUILD_NUMBER)"

      - name: Create build directory
        run: |
          mkdir -p build/workdir
          mkdir -p build/output

      - name: Download Tailscale binaries
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Download for multiple architectures
          echo "Downloading Tailscale $VERSION binaries..."

          # amd64
          curl -sSLf --ipv4 -o build/tailscale_amd64.tgz \
            "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz"

          # arm64
          curl -sSLf --ipv4 -o build/tailscale_arm64.tgz \
            "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_arm64.tgz"

          # arm
          curl -sSLf --ipv4 -o build/tailscale_arm.tgz \
            "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_arm.tgz"

      - name: Verify Tailscale checksums (if available)
        continue-on-error: true
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          echo "Attempting to download and verify official checksums..."
          if curl -sSLf --ipv4 -o build/tailscale_${VERSION}_checksums.txt \
            "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_checksums.txt"; then

            cd build
            # Verify each downloaded file
            for arch in amd64 arm64 arm; do
              if grep "tailscale_${VERSION}_${arch}.tgz" tailscale_${VERSION}_checksums.txt > /dev/null; then
                echo "Verifying tailscale_${arch}.tgz..."
                grep "tailscale_${VERSION}_${arch}.tgz" tailscale_${VERSION}_checksums.txt | sha256sum -c -
              fi
            done
            cd ..
            echo "âœ“ Official checksums verified"
          else
            echo "âš  Official checksums not available, proceeding without verification"
          fi

      - name: Extract binaries
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Extract all architectures to get binaries
          mkdir -p build/bin

          # Extract amd64 (primary)
          tar xzf build/tailscale_amd64.tgz -C build/workdir

          # Copy binaries from extracted Tailscale package
          cp -r build/workdir/tailscale_${VERSION}_amd64/* build/bin/

          echo "Extracted binaries:"
          ls -lh build/bin/

      - name: Build tailscale-udm package
        run: |
          # Prepare package directory
          cp -R package build/workdir/tailscale
          cp LICENSE build/workdir/tailscale/

          # Copy Tailscale binaries into package
          mkdir -p build/workdir/tailscale/bin
          cp build/bin/tailscale build/workdir/tailscale/bin/
          cp build/bin/tailscaled build/workdir/tailscale/bin/

          # Create on_boot.d directory structure
          mkdir -p build/workdir/on_boot.d
          mv build/workdir/tailscale/on-boot.sh build/workdir/on_boot.d/10-tailscaled.sh

          echo ""
          echo "Package contents:"
          ls -lR build/workdir/
          echo ""

          # Create the package
          tar czf build/output/tailscale-udm.tgz \
            -C build/workdir \
            tailscale on_boot.d \
            --owner=0 --group=0

          echo "Package created:"
          ls -lh build/output/tailscale-udm.tgz

      - name: Generate cryptographic hashes
        id: hashes
        run: |
          cd build/output

          echo "Generating cryptographic hashes..."

          # Generate SHA256
          SHA256=$(sha256sum tailscale-udm.tgz | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

          # Generate SHA512
          SHA512=$(sha512sum tailscale-udm.tgz | awk '{print $1}')
          echo "sha512=$SHA512" >> $GITHUB_OUTPUT
          echo "SHA512: $SHA512"

          # Generate BLAKE2
          BLAKE2=$(b2sum tailscale-udm.tgz | awk '{print $1}')
          echo "blake2=$BLAKE2" >> $GITHUB_OUTPUT
          echo "BLAKE2: $BLAKE2"

      - name: Create hash manifest
        run: |
          cat > build/output/HASHES.txt << EOF
          # Tailscale-UDM Package Hashes
          # Built: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          # Tailscale Version: ${{ steps.version.outputs.version }}
          # Build Number: ${{ steps.version.outputs.build_number }}
          # Source Commit: ${{ github.sha }}
          # GitHub Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          SHA256: ${{ steps.hashes.outputs.sha256 }}
          SHA512: ${{ steps.hashes.outputs.sha512 }}
          BLAKE2: ${{ steps.hashes.outputs.blake2 }}
          EOF

          echo "Hash manifest created:"
          cat build/output/HASHES.txt

      - name: Create build manifest (latest.json)
        run: |
          cat > build/output/latest.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "build_number": "${{ steps.version.outputs.build_number }}",
            "tag": "${{ steps.version.outputs.tag }}",
            "sha256": "${{ steps.hashes.outputs.sha256 }}",
            "sha512": "${{ steps.hashes.outputs.sha512 }}",
            "blake2": "${{ steps.hashes.outputs.blake2 }}",
            "built_at": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "source_commit": "${{ github.sha }}",
            "github_run": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "download_url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/tailscale-udm.tgz"
          }
          EOF

          echo "Build manifest created:"
          cat build/output/latest.json

      - name: Create release notes
        run: |
          cat > build/output/RELEASE_NOTES.md << EOF
          # Tailscale-UDM ${{ steps.version.outputs.tag }}

          ## ðŸ”’ Cryptographically Verified Build

          This package has been built from source with cryptographic verification to eliminate supply chain risks.

          ### ðŸ“¦ Package Details
          - **Tailscale Version:** ${{ steps.version.outputs.version }}
          - **Build Number:** ${{ steps.version.outputs.build_number }}
          - **Built:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Source Commit:** ${{ github.sha }}

          ### ðŸ” Verification Hashes

          **SHA256:** ${{ steps.hashes.outputs.sha256 }}

          **SHA512:** ${{ steps.hashes.outputs.sha512 }}

          **BLAKE2:** ${{ steps.hashes.outputs.blake2 }}

          ### ðŸ“¥ Installation

          **Quick install with automatic verification:**
          ```bash
          export GITHUB_REPO="bloxsome/tailscale-udm"
          curl -sSL https://raw.githubusercontent.com/$GITHUB_REPO/main/install-verified.sh | sh
          ```

          **Manual verification:**
          ```bash
          # Download package
          curl -sSLf -o tailscale-udm.tgz \
            "https://github.com/bloxsome/tailscale-udm/releases/download/${{ steps.version.outputs.tag }}/tailscale-udm.tgz"

          # Verify SHA256
          echo "${{ steps.hashes.outputs.sha256 }}  tailscale-udm.tgz" | sha256sum -c -

          # If verification passes, extract and install
          tar xzf tailscale-udm.tgz -C /data  # or /mnt/data for OS 1.x
          /data/tailscale/manage.sh install
          /data/tailscale/manage.sh start
          ```

          ### ðŸ›¡ï¸ What's Protected

          âœ… Tailscale binaries verified against official checksums (when available)
          âœ… Package integrity verified with SHA256/SHA512/BLAKE2 hashes
          âœ… Transparent build process on GitHub Actions
          âœ… Reproducible builds with version pinning

          ### âš ï¸ Trust Model

          You are trusting:
          - GitHub Actions infrastructure
          - This repository owner (bloxsome)
          - Tailscale's official binary distribution
          - The cryptographic hash algorithms (SHA256/SHA512/BLAKE2)

          ### ðŸ“š Documentation

          For more information, see the [repository README](https://github.com/bloxsome/tailscale-udm).
          EOF

          cat build/output/RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@9d7c94cfd0a1f3ed45544c887983e9fa900f0564  # v2.0.4
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Tailscale-UDM ${{ steps.version.outputs.tag }}
          body_path: build/output/RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            build/output/tailscale-udm.tgz
            build/output/HASHES.txt
            build/output/latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          echo "## âœ… Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Hashes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "SHA256: ${{ steps.hashes.outputs.sha256 }}" >> $GITHUB_STEP_SUMMARY
          echo "SHA512: ${{ steps.hashes.outputs.sha512 }}" >> $GITHUB_STEP_SUMMARY
          echo "BLAKE2: ${{ steps.hashes.outputs.blake2 }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Install Command" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'export GITHUB_REPO="bloxsome/tailscale-udm"' >> $GITHUB_STEP_SUMMARY
          echo 'curl -sSL https://raw.githubusercontent.com/$GITHUB_REPO/main/install-verified.sh | sh' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const title = `Automated build failed for Tailscale version check`;
            const body = `The weekly automated build workflow failed.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Triggered:** ${{ github.event_name }}
            **Branch:** ${{ github.ref }}

            Please investigate and manually trigger a build if needed.`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated-build-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automated-build-failure', 'bug']
              });
            }
